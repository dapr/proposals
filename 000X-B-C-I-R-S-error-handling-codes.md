# Dapr Error Handling/Codes 

* Author(s): Roberto J. Rojas
* State: Draft
* Updated: 5/10/2023

## Overview

Across Dapr errors are surfaced for different conditions, without consistent messages, details of the error, standard formats, and no clear indication of what/where the error initiated. 

This makes troubleshooting and debugging quite difficult and requires a deep understanding of the parts of Dapr and how those parts interact with each other.

To help with the issues raised above, it would be ideal if a solution could provide:
- Greater details of errors that occured.
- Error details in a structured format.
- Consistency in the error details.
- An indication where within the Dapr execution (Init, Runtime, Components, SDKs, etc...) the error occurred.

## Background

## Related Items

### Related proposals 


### Related issues 

https://github.com/dapr/dapr/issues/6068

## Expectations and alternatives

## Implementation Details

# Design

## Solution
Utilize and follow the [gRPC Richer Error Model](https://grpc.io/docs/guides/error/#richer-error-model) and [Google API Errors Model in the Design Guide](https://cloud.google.com/apis/design/errors#error_model)

### Error Code Standard
The [Google API Error Model](https://cloud.google.com/apis/design/errors#error_model) has the following Protobuf format:
```go
package google.rpc;

// The `Status` type defines a logical error model that is suitable for
// different programming environments, including REST APIs and RPC APIs.
message Status {
  // A simple error code that can be easily handled by the client. The
  // actual error code is defined by `google.rpc.Code`.
  int32 code = 1;

  // A developer-facing human-readable error message in English. It should
  // both explain the error and offer an actionable resolution to it.
  string message = 2;

  // Additional error information that the client code can use to handle
  // the error, such as retry info or a help link.
  repeated google.protobuf.Any details = 3;
}
```

Here is one of the possible details that can be added to the above
error structure. This is defined in the [error_details.proto Protobuf](https://github.com/googleapis/googleapis/blob/master/google/rpc/error_details.proto) 

```go
message ErrorInfo {
  // The reason of the error. This is a constant value that identifies the
  // proximate cause of the error. Error reasons are unique within a particular
  // domain of errors. This should be at most 63 characters and match a
  // regular expression of `[A-Z][A-Z0-9_]+[A-Z0-9]`, which represents
  // UPPER_SNAKE_CASE.
  string reason = 1;

  // The logical grouping to which the "reason" belongs. The error domain
  // is typically the registered service name of the tool or product that
  // generates the error. Example: "pubsub.googleapis.com". If the error is
  // generated by some common infrastructure, the error domain must be a
  // globally unique value that identifies the infrastructure. For Google API
  // infrastructure, the error domain is "googleapis.com".
  string domain = 2;

  // Additional structured details about this error.
  //
  // Keys should match /[a-zA-Z0-9-_]/ and be limited to 64 characters in
  // length. When identifying the current value of an exceeded limit, the units
  // should be contained in the key, not the value.  For example, rather than
  // {"instanceLimit": "100/request"}, should be returned as,
  // {"instanceLimitPerRequest": "100"}, if the client exceeds the number of
  // instances that can be created in a single (batch) request.
  map<string, string> metadata = 3;
}
```


Example error:
```json
{
  "error": {
    "code": 400,
    "message": "API key not valid. Please pass a valid API key.",
    "status": "INVALID_ARGUMENT",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.ErrorInfo",
        "reason": "API_KEY_INVALID",
        "domain": "googleapis.com",
        "metadata": {
          "service": "translate.googleapis.com"
        }
      }
    ]
  }
}
```


Below is partial table of the Standard Error code provided by gRPC and how they map to HTTP error codes. The entire list can found in the following links:
- [gRPC Codes Table]https://cloud.google.com/apis/design/errors#handling_errors
- (gRPC Codes ProtoBuf)[https://github.com/googleapis/googleapis/blob/master/google/rpc/code.proto]


|HTTP | gRPC      | Description |
|---- | ----------- | ----------- |
|200  |	OK		  | No error. |
|400  |	INVALID_ARGUMENT |	Client specified an invalid argument. Check error message and error details for more information. |
|400  |	FAILED_PRECONDITION |	Request can not be executed in the current system state, such as deleting a non-empty directory. |
|400  |	OUT_OF_RANGE |	Client specified an invalid range. |
|401  |	UNAUTHENTICATED	| Request not authenticated due to missing, invalid, or expired OAuth token. |
|403  |	PERMISSION_DENIED |	Client does not have sufficient permission. This can happen because the OAuth token does not have the right scopes, the client doesn't have permission, or the API has not been enabled. |
|404  |	NOT_FOUND |	A specified resource is not found. |
|409  |	ABORTED	| Concurrency conflict, such as read-modify-write conflict. |

### Error Details Classification
The following tables shows the propsosed error codes used in the **reason** for the **google.rpc.ErrorInfo** within the various levels of Dapr modules:

**INIT**
| Dapr Module | Description |
| ----------- | ----------- |
| CLI         | DAPR_CLI_INIT |
| Self-hosted | DAPR_SELF_HOSTED_INIT |
| K8S         | DAPR_K8S_INIT |
| Invoke      | DAPR_INVOKE_INIT |

**RUNTIME**
| Dapr Module | Description |
| ----------- | ----------- |
| CLI         | DAPR_CLI_RUNTIME |
| Self-hosted | DAPR_SELF_HOSTED_RUNTIME |
| dapr-2-dapr(HTTP) | DAPR_HTTP_RUNTIME |
| dapr-2-dapr(gRPC) | DAPR_GRPC_RUNTIME |

**COMPONENTS**
| Dapr Module | Description |
| ----------- | ----------- |
| PubSub              | DAPR_PUBSUB_COMPONENT |
| StateStore          | DAPR_STATE_STORE_COMPONENT |
| Bindings            | DAPR_BINDING_COMPONENT |
| SecretStore         | DAPR_SECRET_STORE_COMPONENT |
| ConfigurationStore  | DAPR_CONFIGURATION_STORE_COMPONENT |
| Lock                | DAPR_LOCK_COMPONENT |
| NameResolution      | DAPR_NAME_RESOLUTION_COMPONENT |
| Middleware          | DAPR_MIDDLEWARE_COMPONENT|



### Sample Error
```json
{
  "code": 8089,
  "message": "unable to perform Redis.HGETALL call: dial tcp [::1]:6379: connect: connection refused",
  "details": [
    {
      "@type": "type.googleapis.com/google.rpc.ErrorInfo",
      "reason": "DAPR_STATE_STORE_COMPONENT",
      "domain": "dapr.io",
      "metadata": {
        "key": "myapp||name"
      }
    },
    {
      "@type": "type.googleapis.com/google.rpc.ResourceInfo",
      "resource_type": "StateStore",
      "resource_name": "REDIS",
      "owner": "",
      "description": "unable to perform Redis.HGETALL call: dial tcp [::1]:6379: connect: connection refused"
    }
  ]
}
```


### Sample Code Snippet (Go)
```go
import (
   ...
   "google.golang.org/genproto/googleapis/rpc/errdetails"
   "google.golang.org/grpc/codes"
   "google.golang.org/grpc/status"
   ...
)
...
if err != nil {
  ...
  ste := status.Newf(codes.Internal, messages.ErrStateGet, in.Key, in.StoreName, err.Error())
  ei := errdetails.ErrorInfo{
	 Domain: "grpc.runtime.dapr.io",
         Reason: "DAPR_GRPC_RUNTIME",
	 Metadata: map[string]string{
	       "key":       in.Key,
	       "storeName": in.StoreName,
	 },
  }
  ste, err2 := ste.WithDetails(&ei)
  ...
}
```

### Dapr Custom Error Info
```go
message DaprKitErrorInfo {
  string reason = 1;
  string domain = 2;
  map<string, string> metadata = 3;
}
```

### Example Dapr Custom Error Info
```json
{
  "code": 8089,
  "message": "unable to perform Redis.HGETALL call: dial tcp [::1]:6379: connect: connection refused",
  "details": [
    {
      "@type": "type.googleapis.com/google.rpc.ErrorInfo",
      "reason": "DAPR_STATE_STORE_COMPONENT",
      "domain": "dapr.io",
      "metadata": {
        "key": "myapp||name"
      }
    },
    {
      "@type": "type.googleapis.com/google.rpc.ResourceInfo",
      "resource_type": "StateStore",
      "resource_name": "REDIS",
      "owner": "",
      "description": "unable to perform Redis.HGETALL call: dial tcp [::1]:6379: connect: connection refused"
    },
    {
      "@type": "type.googleapis.com/kit.proto.customerrors.v1.DaprKitErrorInfo",
      "reason": "DAPR_STATE_STORE_COMPONENT",
      "domain": "dapr.io",
      "metadata": {
        "key": "myapp||name"
      }
    }
  ]
}
```
### Pros
- Since the Dapr Runtime is using protocol buffers as the data format, support for the richer error model is already included in most of the gRPC implementations.
- This would help minimize the changes with the Dapr ecosystem.
- This solution could be used to programmatically react to errors as it provides a standard structure for the errors with details.

### Cons
- Dependencies on gPRC richer error model.
- Not all gRPC implementations support this out of the box, [C#/dotnet](https://learn.microsoft.com/en-us/dotnet/architecture/grpc-for-wcf-developers/error-handling#grpc-richer-error-model) being one of them, but there is a [possible solution (Google.Api.CommonProtos)](https://www.nuget.org/packages/Google.Api.CommonProtos/) to this.


## gRPC Richer Error Model POC
For the POC I've made changes to some parts of the Dapr modules (). The POC code can be found in my GH Repo under the branch **error-codes-poc**

These are the gRPC imports used:

```go
import (
  ...
  "google.golang.org/genproto/googleapis/rpc/errdetails"
  "google.golang.org/grpc/codes"
  "google.golang.org/grpc/status"
  ...
)
```

The files changed for this POC:

https://github.com/robertojrojas/components-contrib/tree/error-codes-poc

- state/redis/redis.go
- state/store.go

https://github.com/robertojrojas/dapr-kit/tree/error-codes-poc

- pkg/proto/customerrors/v1/customerrors.pb.go
- proto/customerrors/v1/customerrors.proto
- status/customerrorcodes.go
- status/status.go

https://github.com/robertojrojas/dapr/tree/error-codes-poc

- pkg/diagnostics/grpc_tracing.go
- pkg/grpc/api.go
- pkg/http/api.go
- pkg/http/responses.go

https://github.com/robertojrojas/dapr-go-sdk/tree/error-codes-poc

- client/state.go

https://github.com/robertojrojas/dapr-cli/tree/error-codes-poc

- pkg/standalone/invoke.go


### Feature lifecycle outline

### Acceptance Criteria


## Completion Checklist

